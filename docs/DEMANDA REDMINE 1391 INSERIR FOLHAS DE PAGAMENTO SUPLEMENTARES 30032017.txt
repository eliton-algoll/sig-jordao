-- demanda redmine 1391  - script para criação de folha de ponto suplementar

SELECT * FROM dbpet.TB_FOLHA_PAGAMENTO ORDER BY 4;
SELECT * FROM dbpet.TB_SITUACAO_FOLHA;
SELECT * FROM dbpet.TB_SITUACAO_PROJETO_FOLHA;

 --insere nova folha suplementar para o mes de maio de 2016 - 4.° LOTE 
 DECLARE 
 V_MES_FOLHA VARCHAR2(2) NOT NULL := '05';
 V_ANO_FOLHA VARCHAR2(4) NOT NULL := '2016';
 V_TOTAL_FOLHA NUMBER(10,2);
V_COD_FOLHA NUMBER(3) NOT NULL := 10;
V_PROJ_FOLHA_PAG NUMBER(5);
V_FOLHA_PAGTO NUMBER(3);
 BEGIN  
 
 INSERT INTO DBPET.TB_FOLHA_PAGAMENTO
   (CO_SEQ_FOLHA_PAGAMENTO,
    CO_PUBLICACAO,
    CO_SITUACAO_FOLHA,
    NU_MES,
    NU_ANO,
    NU_SIPAR,
    VL_TOTAL,
    DT_INCLUSAO,
    ST_REGISTRO_ATIVO,
    NU_ORDEM_BANCARIA,
    TP_FOLHA_PAGAMENTO)
 VALUES
   (V_COD_FOLHA,
    1,
    3, 
   V_MES_FOLHA,
   V_ANO_FOLHA,
    NULL,
    NULL,
    SYSDATE,
    'S',
    NULL,
    'S');				
		
	BEGIN FOR C1 IN (
SELECT distinct A.CO_SEQ_PROJETO, A.NU_SIPAR, a.NU_CPF_CNPJ_PESSOA, A.CO_SEQ_PROJETO_PESSOA, A.VL_BOLSA,  A.CO_BANCO, A.CO_AGENCIA
  FROM DBPET.VW_PARTICIPANTE A
 WHERE A.NU_CPF_CNPJ_PESSOA IN ('31736348884',
'07843397752',
'09786494601',
'04360748779',
'03432982607',
'01883655838',
'14978425735',
'90365844772',
'02566220433',
'60566418991',
'02890444643')) LOOP 

SELECT FP.CO_SEQ_FOLHA_PAGAMENTO,PFP.CO_SEQ_PROJ_FOLHA_PAGAM INTO V_FOLHA_PAGTO, V_PROJ_FOLHA_PAG
FROM DBPET.TB_FOLHA_PAGAMENTO FP 
LEFT JOIN DBPET.TB_PROJETO_FOLHAPAGAMENTO PFP
ON FP.CO_SEQ_FOLHA_PAGAMENTO = PFP.CO_FOLHA_PAGAMENTO
AND PFP.CO_PROJETO = C1.CO_SEQ_PROJETO
WHERE FP.CO_SEQ_FOLHA_PAGAMENTO = V_COD_FOLHA
;

DBMS_OUTPUT.PUT_LINE('codigo projeto folha= '|| V_PROJ_FOLHA_PAG || ', folha de pagamento= ' || V_FOLHA_PAGTO) ;

IF 	V_PROJ_FOLHA_PAG IS NULL	THEN 
 INSERT INTO DBPET.TB_PROJETO_FOLHAPAGAMENTO
   (CO_SEQ_PROJ_FOLHA_PAGAM,
    CO_PROJETO,
    CO_FOLHA_PAGAMENTO,
    CO_SITUACAO_PROJ_FOLHA,
    ST_PARECER,
    DS_JUSTIFICATIVA,
    DT_INCLUSAO,
    ST_REGISTRO_ATIVO)
 VALUES
   (DBPET.SQ_PROJFLSPAG_COSEQPROJFLSPAG.NEXTVAL,
    C1.CO_SEQ_PROJETO,
    DBPET.SQ_FOLHAPAGAM_COSEQFOLHAPAGAM.CURRVAL,
    4, --Enviada para pagamento
    'S',
    'FOLHA SUPLEMENTAR PARA PAGAMENTO DE PROFISSIONAIS QUE NÃO RECEBERAM NA FOLHA MENSAL',
    SYSDATE,
    'S');				
		END IF;
	
				      
    INSERT INTO DBPET.TB_AUTORIZACAO_FOLHA
      (CO_SEQ_AUTORIZACAO_FOLHA,
       CO_PROJ_FOLHA_PAGAM,
       CO_PROJETO_PESSOA,
       VL_BOLSA,
       ST_PARECER,
       DT_INCLUSAO,
       ST_REGISTRO_ATIVO,
       CO_BANCO,
       CO_AGENCIA_BANCARIA)
    VALUES
      (DBPET.SQ_AUTORFOLHA_COSEQAUTORFOLHA.NEXTVAL, 
      V_PROJETOFOLHA, 
      C1.CO_SEQ_PROJETO_PESSOA, 
      C1.VL_BOLSA, 
      'S', 
      SYSDATE, 
      'S',      
      C1.CO_BANCO, 
      C1.CO_AGENCIA   
      );	
		
END LOOP;
		
END LOOP;
END;
			
		
	--insere nova folha suplementar para o mes de junho de 2016 - 2.° LOTE 
 V_MES_FOLHA VARCHAR2(2) NOT NULL := '06';
 V_ANO_FOLHA VARCHAR2(4) NOT NULL := '2016';
 V_TOTAL_FOLHA NUMBER(10,2);
V_COD_FOLHA NUMBER(3) NOT NULL := 11;
V_PROJ_FOLHA_PAG NUMBER(5);
V_FOLHA_PAGTO NUMBER(3);
 BEGIN  
 
 INSERT INTO DBPET.TB_FOLHA_PAGAMENTO
   (CO_SEQ_FOLHA_PAGAMENTO,
    CO_PUBLICACAO,
    CO_SITUACAO_FOLHA,
    NU_MES,
    NU_ANO,
    NU_SIPAR,
    VL_TOTAL,
    DT_INCLUSAO,
    ST_REGISTRO_ATIVO,
    NU_ORDEM_BANCARIA,
    TP_FOLHA_PAGAMENTO)
 VALUES
   (V_COD_FOLHA,
    1,
    3, 
   V_MES_FOLHA,
   V_ANO_FOLHA,
    NULL,
    NULL,
    SYSDATE,
    'S',
    NULL,
    'S');       
    
  BEGIN FOR C1 IN (
SELECT distinct A.CO_SEQ_PROJETO, A.NU_SIPAR, a.NU_CPF_CNPJ_PESSOA, A.CO_SEQ_PROJETO_PESSOA, A.VL_BOLSA,  A.CO_BANCO, A.CO_AGENCIA
  FROM DBPET.VW_PARTICIPANTE A
 WHERE A.NU_CPF_CNPJ_PESSOA IN ('02566220433')) LOOP 

SELECT FP.CO_SEQ_FOLHA_PAGAMENTO,PFP.CO_SEQ_PROJ_FOLHA_PAGAM INTO V_FOLHA_PAGTO, V_PROJ_FOLHA_PAG
FROM DBPET.TB_FOLHA_PAGAMENTO FP 
LEFT JOIN DBPET.TB_PROJETO_FOLHAPAGAMENTO PFP
ON FP.CO_SEQ_FOLHA_PAGAMENTO = PFP.CO_FOLHA_PAGAMENTO
AND PFP.CO_PROJETO = C1.CO_SEQ_PROJETO
WHERE FP.CO_SEQ_FOLHA_PAGAMENTO = V_COD_FOLHA
;

DBMS_OUTPUT.PUT_LINE('codigo projeto folha= '|| V_PROJ_FOLHA_PAG || ', folha de pagamento= ' || V_FOLHA_PAGTO) ;

IF  V_PROJ_FOLHA_PAG IS NULL  THEN 
 INSERT INTO DBPET.TB_PROJETO_FOLHAPAGAMENTO
   (CO_SEQ_PROJ_FOLHA_PAGAM,
    CO_PROJETO,
    CO_FOLHA_PAGAMENTO,
    CO_SITUACAO_PROJ_FOLHA,
    ST_PARECER,
    DS_JUSTIFICATIVA,
    DT_INCLUSAO,
    ST_REGISTRO_ATIVO)
 VALUES
   (DBPET.SQ_PROJFLSPAG_COSEQPROJFLSPAG.NEXTVAL,
    C1.CO_SEQ_PROJETO,
    DBPET.SQ_FOLHAPAGAM_COSEQFOLHAPAGAM.CURRVAL,
    4, --Enviada para pagamento
    'S',
    'FOLHA SUPLEMENTAR PARA PAGAMENTO DE PROFISSIONAIS QUE NÃO RECEBERAM NA FOLHA MENSAL',
    SYSDATE,
    'S');       
    END IF;
  
              
    INSERT INTO DBPET.TB_AUTORIZACAO_FOLHA
      (CO_SEQ_AUTORIZACAO_FOLHA,
       CO_PROJ_FOLHA_PAGAM,
       CO_PROJETO_PESSOA,
       VL_BOLSA,
       ST_PARECER,
       DT_INCLUSAO,
       ST_REGISTRO_ATIVO,
       CO_BANCO,
       CO_AGENCIA_BANCARIA)
    VALUES
      (DBPET.SQ_AUTORFOLHA_COSEQAUTORFOLHA.NEXTVAL, 
      V_PROJETOFOLHA, 
      C1.CO_SEQ_PROJETO_PESSOA, 
      C1.VL_BOLSA, 
      'S', 
      SYSDATE, 
      'S',      
      C1.CO_BANCO, 
      C1.CO_AGENCIA   
      );  
    
END LOOP;
    
END LOOP;
END;
      

	--insere nova folha suplementar para o mes de setembro de 2016 - 3.° LOTE 
 V_MES_FOLHA VARCHAR2(2) NOT NULL := '09';
 V_ANO_FOLHA VARCHAR2(4) NOT NULL := '2016';
 V_TOTAL_FOLHA NUMBER(10,2);
V_COD_FOLHA NUMBER(3) NOT NULL := 12;
V_PROJ_FOLHA_PAG NUMBER(5);
V_FOLHA_PAGTO NUMBER(3);
 BEGIN  
 
 INSERT INTO DBPET.TB_FOLHA_PAGAMENTO
   (CO_SEQ_FOLHA_PAGAMENTO,
    CO_PUBLICACAO,
    CO_SITUACAO_FOLHA,
    NU_MES,
    NU_ANO,
    NU_SIPAR,
    VL_TOTAL,
    DT_INCLUSAO,
    ST_REGISTRO_ATIVO,
    NU_ORDEM_BANCARIA,
    TP_FOLHA_PAGAMENTO)
 VALUES
   (V_COD_FOLHA,
    1,
    3, 
   V_MES_FOLHA,
   V_ANO_FOLHA,
    NULL,
    NULL,
    SYSDATE,
    'S',
    NULL,
    'S');       
    
  BEGIN FOR C1 IN (
SELECT distinct A.CO_SEQ_PROJETO, A.NU_SIPAR, a.NU_CPF_CNPJ_PESSOA, A.CO_SEQ_PROJETO_PESSOA, A.VL_BOLSA,  A.CO_BANCO, A.CO_AGENCIA
  FROM DBPET.VW_PARTICIPANTE A
 WHERE A.NU_CPF_CNPJ_PESSOA IN ('70342298135', '02566220433', '45540104811')) LOOP 

SELECT FP.CO_SEQ_FOLHA_PAGAMENTO,PFP.CO_SEQ_PROJ_FOLHA_PAGAM INTO V_FOLHA_PAGTO, V_PROJ_FOLHA_PAG
FROM DBPET.TB_FOLHA_PAGAMENTO FP 
LEFT JOIN DBPET.TB_PROJETO_FOLHAPAGAMENTO PFP
ON FP.CO_SEQ_FOLHA_PAGAMENTO = PFP.CO_FOLHA_PAGAMENTO
AND PFP.CO_PROJETO = C1.CO_SEQ_PROJETO
WHERE FP.CO_SEQ_FOLHA_PAGAMENTO = V_COD_FOLHA
;

DBMS_OUTPUT.PUT_LINE('codigo projeto folha= '|| V_PROJ_FOLHA_PAG || ', folha de pagamento= ' || V_FOLHA_PAGTO) ;

IF  V_PROJ_FOLHA_PAG IS NULL  THEN 
 INSERT INTO DBPET.TB_PROJETO_FOLHAPAGAMENTO
   (CO_SEQ_PROJ_FOLHA_PAGAM,
    CO_PROJETO,
    CO_FOLHA_PAGAMENTO,
    CO_SITUACAO_PROJ_FOLHA,
    ST_PARECER,
    DS_JUSTIFICATIVA,
    DT_INCLUSAO,
    ST_REGISTRO_ATIVO)
 VALUES
   (DBPET.SQ_PROJFLSPAG_COSEQPROJFLSPAG.NEXTVAL,
    C1.CO_SEQ_PROJETO,
    DBPET.SQ_FOLHAPAGAM_COSEQFOLHAPAGAM.CURRVAL,
    4, --Enviada para pagamento
    'S',
    'FOLHA SUPLEMENTAR PARA PAGAMENTO DE PROFISSIONAIS QUE NÃO RECEBERAM NA FOLHA MENSAL',
    SYSDATE,
    'S');       
    END IF;
  
              
    INSERT INTO DBPET.TB_AUTORIZACAO_FOLHA
      (CO_SEQ_AUTORIZACAO_FOLHA,
       CO_PROJ_FOLHA_PAGAM,
       CO_PROJETO_PESSOA,
       VL_BOLSA,
       ST_PARECER,
       DT_INCLUSAO,
       ST_REGISTRO_ATIVO,
       CO_BANCO,
       CO_AGENCIA_BANCARIA)
    VALUES
      (DBPET.SQ_AUTORFOLHA_COSEQAUTORFOLHA.NEXTVAL, 
      V_PROJETOFOLHA, 
      C1.CO_SEQ_PROJETO_PESSOA, 
      C1.VL_BOLSA, 
      'S', 
      SYSDATE, 
      'S',      
      C1.CO_BANCO, 
      C1.CO_AGENCIA   
      );      
END LOOP;    
END LOOP;
END;
      
